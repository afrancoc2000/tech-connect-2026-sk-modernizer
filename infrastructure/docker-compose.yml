version: '3.8'

services:
  # Azure Container Registry - Simulate local registry
  registry:
    image: registry:2
    container_name: ai-modernizer-registry
    ports:
      - "5000:5000"
    environment:
      REGISTRY_STORAGE_DELETE_ENABLED: 'true'
    volumes:
      - registry_storage:/var/lib/registry
    networks:
      - app-network

  # AI Modernizer Application
  ai-modernizer:
    build:
      context: ../AIAppsModernization
      dockerfile: Dockerfile
    container_name: ai-modernizer-app
    ports:
      - "8000:8000"
    environment:
      - FOUNDRY_MODEL_DEPLOYMENT_NAME=gpt-4o
      - AZURE_OPENAI_KEY=${AZURE_OPENAI_KEY}
      - AZURE_OPENAI_ENDPOINT=${AZURE_OPENAI_ENDPOINT}
      - ENVIRONMENT=development
      - LOG_LEVEL=INFO
    depends_on:
      - registry
    networks:
      - app-network
    volumes:
      - ../AIAppsModernization:/app
    command: python main.py --server
    restart: unless-stopped

  # Mock API Management
  apim-mock:
    image: nginx:latest
    container_name: apim-gateway
    ports:
      - "8080:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - ai-modernizer
    networks:
      - app-network
    restart: unless-stopped

  # Log Analytics / Monitoring
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_storage:/prometheus
    networks:
      - app-network
    restart: unless-stopped

  # Metrics Visualization
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_SECURITY_ADMIN_USER: admin
    depends_on:
      - prometheus
    volumes:
      - grafana_storage:/var/lib/grafana
    networks:
      - app-network
    restart: unless-stopped

  # Key Vault Mock (HashiCorp Vault)
  vault:
    image: vault:latest
    container_name: vault
    ports:
      - "8200:8200"
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: dev-token
      VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8200
      VAULT_ADDR: http://127.0.0.1:8200
    volumes:
      - vault_storage:/vault/file
    networks:
      - app-network
    cap_add:
      - IPC_LOCK
    restart: unless-stopped

  # Storage Account Mock
  storage:
    image: mcr.microsoft.com/azure-storage/azurite:latest
    container_name: azurite
    ports:
      - "10000:10000"
      - "10001:10001"
      - "10002:10002"
    environment:
      AZURITE_ACCOUNTS: "devstoreaccount1:${ACCOUNT_KEY:?}"
    volumes:
      - azurite_storage:/data
    networks:
      - app-network
    restart: unless-stopped

volumes:
  registry_storage:
  prometheus_storage:
  grafana_storage:
  vault_storage:
  azurite_storage:

networks:
  app-network:
    driver: bridge

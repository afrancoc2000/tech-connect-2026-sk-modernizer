{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "description": "Master ARM Template - Orchestrates nested child templates for modular deployment",
    "author": "Cloud Architecture Team",
    "version": "1.0.0"
  },
  "parameters": {
    "projectName": {
      "type": "string",
      "defaultValue": "aiappsmod",
      "metadata": {
        "description": "Project name"
      }
    },
    "environment": {
      "type": "string",
      "defaultValue": "poc",
      "allowedValues": ["poc", "dev", "staging", "prod"],
      "metadata": {
        "description": "Environment tier"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Azure region for resources"
      }
    },
    "containerRegistrySku": {
      "type": "string",
      "defaultValue": "Standard",
      "allowedValues": ["Standard", "Premium"],
      "metadata": {
        "description": "Container Registry SKU"
      }
    },
    "apiManagementSku": {
      "type": "string",
      "defaultValue": "Developer",
      "metadata": {
        "description": "API Management SKU"
      }
    },
    "templateBaseUri": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Base URI for linked templates (e.g., https://example.com/templates/). Leave empty for local deployment."
      }
    }
  },
  "variables": {
    "uniqueSuffix": "[uniqueString(resourceGroup().id)]",
    "naming": "[concat(parameters('projectName'), '-', parameters('environment'), '-')]",
    "vnetName": "[concat(variables('naming'), 'vnet')]",
    "storageName": "[replace(concat(parameters('projectName'), parameters('environment'), 'sa', substring(variables('uniqueSuffix'), 0, 4)), '-', '')]",
    "kvName": "[concat(variables('naming'), 'kv-', substring(variables('uniqueSuffix'), 0, 4))]",
    "acrName": "[replace(concat(parameters('projectName'), parameters('environment'), 'acr', substring(variables('uniqueSuffix'), 0, 4)), '-', '')]",
    "appInsightsName": "[concat(variables('naming'), 'appins')]",
    "logAnalyticsName": "[concat(variables('naming'), 'logs')]",
    "apimName": "[concat(variables('naming'), 'apim')]",
    "aiHubName": "[concat(parameters('projectName'), '-hub-', substring(variables('uniqueSuffix'), 0, 4))]",
    "aiProjectName": "[concat(parameters('projectName'), '-project-', substring(variables('uniqueSuffix'), 0, 4))]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2023-07-01",
      "name": "deploy-network",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[if(empty(parameters('templateBaseUri')), uri(deployment().properties.templateLink.uri, 'child-network.json'), concat(parameters('templateBaseUri'), 'child-network.json'))]"
        },
        "parameters": {
          "projectName": {
            "value": "[parameters('projectName')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "vnetName": {
            "value": "[variables('vnetName')]"
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2023-07-01",
      "name": "deploy-storage",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[if(empty(parameters('templateBaseUri')), uri(deployment().properties.templateLink.uri, 'child-storage.json'), concat(parameters('templateBaseUri'), 'child-storage.json'))]"
        },
        "parameters": {
          "storageName": {
            "value": "[variables('storageName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2023-07-01",
      "name": "deploy-acr",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[if(empty(parameters('templateBaseUri')), uri(deployment().properties.templateLink.uri, 'child-acr.json'), concat(parameters('templateBaseUri'), 'child-acr.json'))]"
        },
        "parameters": {
          "acrName": {
            "value": "[variables('acrName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "acrSku": {
            "value": "[parameters('containerRegistrySku')]"
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2023-07-01",
      "name": "deploy-keyvault",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[if(empty(parameters('templateBaseUri')), uri(deployment().properties.templateLink.uri, 'child-keyvault.json'), concat(parameters('templateBaseUri'), 'child-keyvault.json'))]"
        },
        "parameters": {
          "kvName": {
            "value": "[variables('kvName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2023-07-01",
      "name": "deploy-monitoring",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[if(empty(parameters('templateBaseUri')), uri(deployment().properties.templateLink.uri, 'child-monitoring.json'), concat(parameters('templateBaseUri'), 'child-monitoring.json'))]"
        },
        "parameters": {
          "appInsightsName": {
            "value": "[variables('appInsightsName')]"
          },
          "logAnalyticsName": {
            "value": "[variables('logAnalyticsName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2023-07-01",
      "name": "deploy-ai-hub",
      "dependsOn": [
        "deploy-storage",
        "deploy-keyvault",
        "deploy-monitoring"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[if(empty(parameters('templateBaseUri')), uri(deployment().properties.templateLink.uri, 'child-ai-hub.json'), concat(parameters('templateBaseUri'), 'child-ai-hub.json'))]"
        },
        "parameters": {
          "aiHubName": {
            "value": "[variables('aiHubName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "storageName": {
            "value": "[variables('storageName')]"
          },
          "kvName": {
            "value": "[variables('kvName')]"
          },
          "appInsightsName": {
            "value": "[variables('appInsightsName')]"
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2023-07-01",
      "name": "deploy-ai-project",
      "dependsOn": [
        "deploy-ai-hub"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[if(empty(parameters('templateBaseUri')), uri(deployment().properties.templateLink.uri, 'child-ai-project.json'), concat(parameters('templateBaseUri'), 'child-ai-project.json'))]"
        },
        "parameters": {
          "aiProjectName": {
            "value": "[variables('aiProjectName')]"
          },
          "aiHubName": {
            "value": "[variables('aiHubName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2023-07-01",
      "name": "deploy-apim",
      "dependsOn": [
        "deploy-network"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[if(empty(parameters('templateBaseUri')), uri(deployment().properties.templateLink.uri, 'child-apim.json'), concat(parameters('templateBaseUri'), 'child-apim.json'))]"
        },
        "parameters": {
          "apimName": {
            "value": "[variables('apimName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "apiManagementSku": {
            "value": "[parameters('apiManagementSku')]"
          },
          "vnetName": {
            "value": "[variables('vnetName')]"
          }
        }
      }
    }
  ],
  "outputs": {
    "deploymentStatus": {
      "type": "string",
      "value": "All child deployments completed successfully"
    },
    "acrLoginServer": {
      "type": "string",
      "value": "[reference('deploy-acr').outputs.acrLoginServer.value]"
    },
    "storageId": {
      "type": "string",
      "value": "[reference('deploy-storage').outputs.storageId.value]"
    },
    "kvId": {
      "type": "string",
      "value": "[reference('deploy-keyvault').outputs.kvId.value]"
    }
  }
}
